---
title: "Economical risk project"
author: "Gabriele Trevisan"
date: "2024-02-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Economical risk project

# SETUP MAC
```{r}
setwd("~/Desktop/Economical-risk-project")
```

# SETUP WINDOWS
```{r}
# Qui dovete mettere il vostro path
# setwd("~\Desktop\Economical-risk-project")
```

## carico Tidyverse
```{r}
library(tidyverse)
```

## Caricamento dei dataset - MAC
```{r}
carcom = read.csv("indagine_2020/carcom20.csv")
debiti =  read.csv("indagine_2020/debiti20.csv")

# Carico gli allegati
debiti_residenza = read.csv("indagine_2020/alld2_res.csv")
debiti_professione = read.csv("indagine_2020/alld2_prof.csv")
debiti_famiglia = read.csv("indagine_2020/alld2_fam.csv")
debiti_altri_immobili = read.csv("indagine_2020/alld2_aimm.csv")
```


## Caricamento dei dataset - WINDOWS
```{r}

carcom = read.csv("indagine_2020\carcom20.csv")
debiti =  read.csv("indagine_2020\debiti20.csv")

# Carico gli allegati
debiti_residenza = read.csv("indagine_2020\alld2_res.csv")
debiti_professione = read.csv("indagine_2020\alld2_prof.csv")
debiti_famiglia = read.csv("indagine_2020\alld2_fam.csv")
debiti_altri_immobili = read.csv("indagine_2020\alld2_aimm.csv")
```


## Pulizia dei dataset
### Carcom
Teniamo solo le variabili che ci servono
```{r}
carcom = carcom %>% select(NQUEST, nord, NCOMP, SEX, ANASC, ETA, CLETA5, PERL, PERC, NPERL, NPERC, Q, QUAL, SETT, AREA5, IREG, ACOM4C)


carcom = carcom %>% rename("classe_eta" = CLETA5)
carcom$classe_eta = as.factor(carcom$classe_eta)

carcom = carcom %>% rename("anno_nascita" = ANASC)
carcom = carcom %>% rename("numero_componenti" = NCOMP)
carcom = carcom %>% rename("status_lavoratore" = Q)
carcom$status_lavoratore = as.factor(carcom$status_lavoratore)

carcom = carcom %>% rename("qualifica_lavoratore" = QUAL)
carcom$qualifica_lavoratore = as.factor(carcom$qualifica_lavoratore)

carcom = carcom %>% rename("settore" = SETT)
carcom$settore = as.factor(carcom$settore)

carcom = carcom %>% rename("area_geografica" = AREA5)
carcom$area_geografica = as.factor(carcom$area_geografica)

carcom = carcom %>% rename("regione_residenza" = IREG)
carcom$regione_residenza = as.factor(carcom$regione_residenza)

carcom = carcom %>% rename("ampiezza_comune" = ACOM4C)
carcom$ampiezza_comune = as.factor(carcom$ampiezza_comune)
```


### Debiti
Pulizia dataset debiti
```{r}
debiti = debiti %>% rename("tot_rate_pagate" = RATADEB)
debiti = debiti %>% rename("tot_rate_res" = RATADEB_RES)
debiti = debiti %>% rename("tot_rate_altri_immobili" = RATADEB_AIMM)
debiti = debiti %>% rename("tot_rate_fam" = RATADEB_FAM)
debiti = debiti %>% rename("tot_rate_professione" = RATADEB_PROF)
debiti = debiti %>% rename("deb_res_immobili" = PFIMM)
debiti = debiti %>% rename("deb_res_beni_consumo" = PFCONS)
debiti = debiti %>% rename("deb_res_mezzi_trasporto" = TDEBITC)
debiti = debiti %>% rename("deb_res_beni_durevoli" = TDEBITD)
debiti = debiti %>% rename("deb_res_beni_non_durevoli" = TDEBITE)
debiti = debiti %>% rename("deb_res_altro" = TDEBITF)
debiti = debiti %>% rename("deb_res_istruzione" = TDEBITG)
debiti = debiti %>% rename("deb_res_professione" = PFAZ)
debiti = debiti %>% rename("deb_carte_credito" = PFCARTE)
debiti = debiti %>% rename("deb_scoperto_cc" = PFCC)
debiti = debiti %>% rename("deb_garanzie_reali" = PFCOLL)
debiti = debiti %>% rename("deb_no_garanzie_reali" = PFNOCOLL)


# Setto a 0 i dati NA
debiti = replace(debiti, is.na(debiti), 0)
```



```{r}
regions_data = read.csv("codici_regioni_prov_comuni.csv", sep=";")
regions_data = regions_data %>% select(Codice.Regione, Denominazione.Regione, Ripartizione.geografica, Codice.Ripartizione.Geografica)
regions_data = distinct(regions_data)
regions_data = regions_data %>% rename("regione_residenza" = "Codice.Regione")
regions_data
```

# Analisi dati

Aggiungo una colonna chiamata "Totale debito" che è la somma di: 
  - Debito residuo per gli immobili 
  - "" per beni di consumo
  - "" della professione
  - "" delle carte di credito
  - "" dello scoperto di conto corrente
```{r}

debiti = debiti %>% mutate(tot_debito = deb_res_immobili + deb_res_beni_consumo + deb_res_professione + deb_carte_credito + deb_scoperto_cc)

print(paste("Debito totale famiglie italiane 2020 nel campione: ", sum(debiti$tot_debito)))
```

```{r}
famiglie_con_debito = debiti %>% filter(debiti$tot_debito > 0)

print(paste("Percentuale di famiglie con debiti:", nrow(famiglie_con_debito)/nrow(debiti) * 100))
```

Ora analizziamo com'è distribuito il debito tra le famiglie che sono indebitate

```{r}
summary(famiglie_con_debito$tot_debito)
```

```{r}
ggplot(famiglie_con_debito) +
  geom_histogram(aes(x = tot_debito))
```
```{r}
# Questo penso sia inutile
ggplot(famiglie_con_debito) +
  geom_boxplot(aes(x = tot_debito))
```



```{r}
ggplot(debiti) +
  geom_histogram(aes(x = tot_debito))
```
# Analisi sul debito e variabili sociodemografiche

In primis ci salviamo da carcom solo le variabili utili per essere analizzate col debito,
ed eliminiamo i doppioni 

```{r}
carcom_per_debito = carcom %>% select(NQUEST, numero_componenti, NPERC,area_geografica, regione_residenza, ampiezza_comune)

# ora elimino i duplicati dal dataframe
carcom_per_debito = distinct(carcom_per_debito)
```

Ora creo il dataframe facendo il join tra i carcom senza duplicati e debiti
```{r}
debiti_full = merge(carcom_per_debito, debiti, by="NQUEST")

head(debiti_full)
```

Proviamo a fare un analisi sul debito per area geografica
```{r}
debito_area_geografica = debiti_full %>% filter(tot_debito > 0) %>% group_by(area_geografica) %>% summarize(mean = mean(tot_debito), median = median(tot_debito), sd = sd(tot_debito)) %>% arrange(desc(mean))
debito_area_geografica
# Specify the path where you want to save the CSV file
file_path <- "debito_residuo_per_area_geografica.csv"

# Export the DataFrame to a CSV file
write.csv(debito_area_geografica, file = file_path, row.names = TRUE)
```

Proviamo a fare un analisi sul debito per regione di residenza
```{r}
debito_per_regione = debiti_full %>% filter(tot_debito > 0) %>% group_by(regione_residenza) %>% summarize(mean = mean(tot_debito), median = median(tot_debito), sd = sd(tot_debito)) %>% arrange(desc(mean))
debito_per_regione = merge(debito_per_regione, regions_data, by="regione_residenza")

ggplot(debito_per_regione) +
  geom_bar(aes(x = reorder(Denominazione.Regione, +median), y = median, fill = Ripartizione.geografica), stat="identity") +
  coord_flip() +
  labs(x = "Regione", y = "Debito residuo mediano per regione")


```

Proviamo a fare un analisi sul debito per ampiezza del comune di residenza
```{r}
debiti_full %>% filter(tot_debito > 0) %>% group_by(ampiezza_comune) %>% summarize(mean = mean(tot_debito), median = median(tot_debito), sd = sd(tot_debito)) %>% arrange(desc(mean))
```


Ora voglio vedere se c'è una correlazione tra il numero di percettori di reddito di una famiglia e il debito
```{r}
debiti_full = debiti_full %>% mutate(rapp_perc = NPERC/numero_componenti)

ggplot(debiti_full %>% filter(tot_debito > 0)) +
  geom_point(aes(x=rapp_perc, y = tot_debito))
```

```{r}
model = lm(tot_debito ~ rapp_perc, data = debiti_full %>% filter(tot_debito > 0))
summary(model)
```

Dalla regressione lineare possiamo vedere come il coefficiente di legato a rapp_perc abbia un p-value bello alto, quindi dobbiamo rigettare l'ipotesi che ci sia una correlazione tra numero di percettori di reddito dij una famiglia e il debito residuo



# Debiti con o senza garanzie reali
si parla sempre di debito residuo, è interessante vedere per ogni famiglia come è distribuita la quota del debito
```{r}
con_deb = debiti_full %>% filter(tot_debito > 0)
con_deb = con_deb %>% mutate(perc_gar_real = deb_garanzie_reali/tot_debito)
con_deb = con_deb %>% mutate(perc_gar_non_real = 1-perc_gar_real)

con_deb %>% select(NQUEST, perc_gar_real)

ggplot(con_deb) +
  geom_histogram(aes(x = perc_gar_real))
```

```{r}
summary(con_deb$perc_gar_real)
```

Assegno una classe alle famiglie che hanno praticamente solo debito con garanzie reali
```{r}
con_deb = con_deb %>% mutate(gar_real = ifelse(perc_gar_real > 0.75, 1, 0)) 

con_deb %>% group_by(gar_real) %>% summarize(count = n())

tipo = con_deb %>% select(NQUEST, gar_real)

hs_eta = carcom %>% group_by(NQUEST) %>% summarize(eta_media = mean(ETA))
con_deb = merge(con_deb, hs_eta, by="NQUEST")
```

```{r}
ggplot(con_deb) +
  geom_point(aes(x = eta_media, y = tot_debito)) +
  scale_y_log10()
```
Da questo grafico possiamo dire che tendenzialmente non c'è una correlazione tra eta media e debito residuo, ma forse possiamo dire che 



```{r}
ggplot(con_deb) +
  geom_point(aes(x = eta_media, y = gar_real)) 
```


 L'età non è nemmeno un indicatore di debito con garanzie reali o no
 
```{r}
#Vediamo se a livello geografico c'è una qualche differenza  tra chi ah debiti con garanzie reali e chi no

perc_gar_real_reg = con_deb %>% group_by(regione_residenza) %>% summarize(perc_con_gar_real = sum(gar_real)/n()) %>% arrange(desc(perc_con_gar_real))
perc_gar_real_reg
```
 Sono risultati interessanti, facciamo un barplot associando le etichette delle regioni
 
```{r}
perc_gar_real_reg = merge(perc_gar_real_reg, regions_data, by="regione_residenza")
perc_gar_real_reg

```

Faccio il grafico
```{r}
ggplot(perc_gar_real_reg) +
  geom_bar(aes(x = reorder(Denominazione.Regione, +perc_con_gar_real), y = perc_con_gar_real, fill = Ripartizione.geografica), stat="identity") +
  coord_flip() +
  labs(x = "Regione", y = "% di debiti con garanzie reali sul totale ")
```
 
 
```{r}
con_deb
```
 


# ANALISI COMPONENTI DEL DEBITO RESIDUO

## PFIMM

= indica il debito residuo per acquisto/ristrutturazione immobili

Quante households hanno ancora debito residuo per acquisto/ristrutturazione immobili?

```{r}
tot_fam_NO_PFIMM = sum(debiti$deb_res_immobili == 0)
cat('Il totale delle households senza PFIMM è: ', tot_fam_NO_PFIMM, '\n')

tot_fam_PFIMM = sum(debiti$deb_res_immobili > 0)
cat('Il totale delle households con PFIMM è: ', tot_fam_PFIMM, '\n')

cat('La percentuale di households che nel 2020 presentano debito residuo per acquisto/ristrutturazione immobili è: ', (tot_fam_PFIMM/(tot_fam_NO_PFIMM+tot_fam_PFIMM))*100,'%', '\n')
```

Delle households con PFIMM, presentiamo un riassunto statistico di media, mediana, quartili, valore minimo, valore massimo:
```{r}
pfimm = debiti %>% select(deb_res_immobili) %>% filter(deb_res_immobili != 0) 
summary(pfimm)
```
Guardiamo la distribuzione di questi valori attraverso l'utilizzo di un'istogramma:

```{r}
library(ggplot2)

ggplot(pfimm, aes(x = deb_res_immobili, y = ..density..)) + 
  geom_histogram(bins = 60) + 
  geom_vline(xintercept = median(pfimm$deb_res_immobili), color = 'red') + 
  geom_vline(xintercept = mean(pfimm$deb_res_immobili), color = 'green')
```
Possiamo vedere come la distribuzione dei valori del debito residuo per acquisto/ristrutturazione immobili non sia normale, ma right-skewed, dal momento che la media ha un valore superiore della mediana.

Ora possiamo anche utilizzare un boxplot per avere una situazione più chiara:

```{r}
# UTILE?

ggplot(pfimm, aes(x = pfimm$deb_res_immobili)) +
  geom_boxplot()
```

### Analisi sul debito e variabili sociodemografiche

In primis ci salviamo da carcom solo le variabili utili per essere analizzate col debito, ed eliminiamo i doppioni:

```{r}
carcom_per_debito = carcom %>% select(NQUEST, numero_componenti, area_geografica, regione_residenza, ampiezza_comune)

# ora elimino i duplicati dal dataframe
carcom_per_debito = distinct(carcom_per_debito)
```

Ora creo il dataframe facendo il join tra i carcom senza duplicati e debiti:
```{r}
debiti_full = merge(carcom_per_debito, debiti, by="NQUEST")

head(debiti_full)
```

In relazione a:

### NUMERO COMPONENTI


```{r}

# Qui ci sta lasciare la mediana invece della media
pfimm_n_componenti = debiti_full %>% filter(deb_res_immobili > 0) %>% group_by(numero_componenti) %>% summarize(mean = mean(deb_res_immobili), median = median(deb_res_immobili), sd = sd(deb_res_immobili)) %>% arrange()

ggplot(pfimm_n_componenti, aes(x = numero_componenti, y = median)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  labs(title = "Mediana del debito residuo per numero di componenti",
       x = "Numero di componenti",
       y = "Media del debito residuo") 

# Perchè qua ho NA su sd?
```

### AREA GEOGRAFICA
```{r}
pfimm_area_geografica = debiti_full %>% filter(deb_res_immobili > 0) %>% group_by(area_geografica) %>% summarize(mean = mean(deb_res_immobili), median = median(deb_res_immobili), sd = sd(deb_res_immobili)) %>% arrange()
pfimm_area_geografica
```

```{r}
etichette_aree = c('Nord-Ovest', 'Nord-Est', 'Centro', 'Sud', 'Isole')
ggplot(pfimm_area_geografica, aes(x = area_geografica, y = "", fill = mean)) +
  geom_tile() +
  scale_fill_gradient(low = "lightgreen", high = "darkgreen") +
  scale_x_discrete(labels = etichette_aree)
```

### REGIONE DI RESIDENZA

```{r}
debiti_full %>% filter(deb_res_immobili > 0) %>% group_by(regione_residenza) %>% summarize(mean = mean(deb_res_immobili), median = median(deb_res_immobili), sd = sd(deb_res_immobili)) %>% arrange(desc(mean)) 
```

## PFAZ

= indica il debito residuo per motivi professionali

Quante households presentano debito residuo nel 2020?
```{r}
tot_fam_NO_PFAZ = sum(debiti$deb_res_professione == 0) 
cat('Il totale delle households senza PFAZ è:', tot_fam_NO_PFAZ, '\n')

tot_fam_PFAZ = sum(debiti$deb_res_professione > 0) 
cat('Il totale delle households con PFAZ è:', tot_fam_PFAZ, '\n')

cat('La percentuale di households che nel 2020 presentano debito residuo per motivi professionali è:', (tot_fam_PFAZ/(tot_fam_NO_PFAZ+tot_fam_PFAZ))*100,'%', '\n')
```
Delle households con PFAZ presentiamo un riassunto statistico di media, mediana, quartili, valore minimo, valore massimo:
```{r}
pfaz = debiti %>% select(deb_res_professione) %>% filter(deb_res_professione != 0) 
summary(pfaz)
```
Guardiamo la distribuzione di questi valori attraverso l'utilizzo di un'istogramma:

```{r}
library(ggplot2)  

ggplot(pfaz, aes(x = deb_res_professione)) +
  geom_histogram(bins = 30) + 
  geom_vline(xintercept = median(pfaz$deb_res_professione), color = 'red') +
  geom_vline(xintercept = mean(pfaz$deb_res_professione), color = 'green') +
  scale_x_log10()
```
Provo a vedere se i debiti res professione sono normali come sembrano



### Analisi sul debito e variabili sociodemografiche
In primis ci salviamo da carcom solo le variabili utili per essere analizzate col debito, ed eliminiamo i doppioni.

```{r}
carcom_pfaz = carcom %>% select(NQUEST, classe_eta, numero_componenti, PERL, NPERL, status_lavoratore, qualifica_lavoratore, settore, area_geografica)

carcom_pfaz = distinct(carcom_pfaz)

```

Ora facciamo il merge tra i due dataset

```{r}
debiti_pfaz = merge(carcom_pfaz,debiti, by = "NQUEST")
debiti_pfaz %>% select(NQUEST, qualifica_lavoratore,deb_res_professione) %>% filter(deb_res_professione > 0) %>%arrange(desc(NQUEST))

```


### STATUS LAVORATORE
```{r}
pfaz_status = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(status_lavoratore) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange()
```

```{r}
etichette = c('1 - Employee', '2 - Self-employed', '3 - Non-Professional')
colori = c('darkorange', 'darkred', 'darkblue')
ggplot(pfaz_status, aes(x = status_lavoratore, y = mean)) +
  geom_bar(stat = 'identity', fill = colori) +
  scale_x_discrete(labels = etichette)
```

### QUALIFICA
```{r}
#Quqesto forse meh
pfaz_qual = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(qualifica_lavoratore) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange() %>% mutate('Qualifica' = c('operaio', 'impiegato', 'dirigente', 'imprenditore/libero professionista', 'altro autonomo', 'pensionato', 'altro non occupato')) %>% select(Qualifica, everything())

colori = c('lightgreen', 'lightblue', 'lightpink', 'yellow', 'darkorange', 'red', 'darkblue')
pie(pfaz_qual$mean, labels = pfaz_qual$Qualifica, col = colori)
```
### SETTORE

```{r}
pfaz_sett = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(settore)%>% mutate(Settore = case_when(
    settore == 1 ~ "Agricoltura",
    settore == 2 ~ "Industria",
    settore == 3 ~ "Servizi Pubblici",
    settore == 4 ~ "Altri settori",
    settore == 5 ~ "Nessun settore")) %>% select(Settore, everything())

pfaz_sett_summarize = pfaz_sett %>% filter(deb_res_professione > 0) %>% group_by(settore) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange()

ggplot(pfaz_sett, aes(x = Settore, y = deb_res_professione)) +
  geom_boxplot() +
  scale_y_log10()
```

### AREA GEOGRAFICA
```{r}
pfaz_area_geografica = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(area_geografica) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange()

etichette_aree = c('Nord-Ovest', 'Nord-Est', 'Centro', 'Sud', 'Isole')
ggplot(pfaz_area_geografica, aes(x = area_geografica, y = "", fill = mean)) +
  geom_tile() +
  scale_fill_gradient(low = "lightyellow", high = "darkorange") +
  scale_x_discrete(labels = etichette_aree)
```
## PFCARTE
= indica il debito su carte di credito

Quante households presentano nel 2020 debito su carte di credito

```{r}
debiti$deb_carte_credito <- replace(debiti$deb_carte_credito, is.na(debiti$deb_carte_credito), 0)

tot_fam_NO_PFCARTE = sum(debiti$deb_carte_credito == 0)
cat('Il totale di household senza PFCARTE è: ', tot_fam_NO_PFCARTE, '\n')

tot_fam_PFCARTE = sum(debiti$deb_carte_credito > 0)
cat('Il totale di household con PFCARTE è: ', tot_fam_PFCARTE, '\n')

cat('La percentuale di household con debito su carte di credito è: ', (tot_fam_PFCARTE/(tot_fam_NO_PFCARTE + tot_fam_PFCARTE))*100,'%', '\n')
```
```{r}
#Ha senso fare un'analisi considerando le variabili di carcom dal momento che abbiamo 47 households con debito su carta di credito????
```

## PFCC
= indica lo scoperto su conti correnti

Quante households presentano nel 2020 scoperto su conti correnti?
```{r}
debiti$deb_scoperto_cc <- replace(debiti$deb_scoperto_cc, is.na(debiti$deb_scoperto_cc), 0)

tot_fam_NO_PFCC = sum(debiti$deb_scoperto_cc == 0)
cat('Il totale di household senza PFCC è: ', tot_fam_NO_PFCC, '\n')

tot_fam_PFCC = sum(debiti$deb_scoperto_cc > 0)
cat('Il totale di household con PFCC è: ', tot_fam_PFCC, '\n')

cat('La percentuale di household con debito su carte di credito è: ', (tot_fam_PFCC/(tot_fam_NO_PFCC + tot_fam_PFCC))*100,'%', '\n')
```
Analizziamo la distribuzione dei dati attraverso un istogramma:

```{r}
deb_scoperto = debiti %>% filter(deb_scoperto_cc > 0) 
ggplot(deb_scoperto, aes(x = deb_scoperto_cc)) +
  geom_histogram(bins = 30) +
  geom_vline(xintercept = mean(deb_scoperto$deb_scoperto_cc), color = 'green') +
  geom_vline(xintercept = median(deb_scoperto$deb_scoperto_cc), color = 'red')
```


# Economical risk project
```{r}
# Qui dovete mettere il vostro path
setwd("C:\\Users\\Alberto-PC\\Downloads\\ind20_ascii\\CSV")
```

## carico Tidyverse
```{r}
library(tidyverse)
```

```{r}
carcom20 <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/carcom20.csv", sep=";")
debiti20 <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/debiti20.csv", sep=";")
alld2_res <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_res.csv", sep=";")
alld2_prof <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_prof.csv", sep=";")
alld2_fam <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_fam.csv", sep=";")
alld2_aimm <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_aimm.csv", sep=";")
```

TDEBITC (mezzi di trasporto), TDEBITD (beni durevoli), TDEBITE (beni non durevoli), TDEBITF (altri acquisti o spese quotidiane), TDEBITG (spese di istruzione)
```{r}
debiti20
```

##PCONS - Distribuzione per componente
#Analisi componenti debito residuo per acquisto beni di consumo rispetto varie voci (trasporto, beni durevoli, beni non durevoli, altri acquisti/spese quotidiane, istruzione:
```{r}
percent_residual_debt_transportation <- sum(debiti20$TDEBITC, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_durable <- sum(debiti20$TDEBITD, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_nondurable <- sum(debiti20$TDEBITE, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_other_everydayexpenses <- sum(debiti20$TDEBITF, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_education <- sum(debiti20$TDEBITG, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)

perc <- data.frame(
  "Percent_residual_debt" = c(
    "Transportation" = percent_residual_debt_transportation,
    "Durable" = percent_residual_debt_durable,
    "Non-durable" = percent_residual_debt_nondurable,
    "Other Everyday Expenses" = percent_residual_debt_other_everydayexpenses,
    "Education" = percent_residual_debt_education))
print(perc)
```

```{r}
percentages <- c(
  "Transportation" = percent_residual_debt_transportation,
  "Durable" = percent_residual_debt_durable,
  "Non-durable" = percent_residual_debt_nondurable,
  "Other Everyday Expenses" = percent_residual_debt_other_everydayexpenses,
  "Education" = percent_residual_debt_education)

df <- data.frame(
  group = names(percentages),
  value = percentages)

pie_chart <- ggplot(df, aes(x = "", y = value, fill = group)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  ggtitle("Percentage of Residual Debt by Category") +
  theme_void()
print(pie_chart)
```


#ATTENZIONE QUI NO DISTINCT
#Seleziono informazioni secondo CFCRED = 1 (capofamiglia con maggiore reddito):
```{r}
carcom20 = filter(carcom20, CFRED == 1)
```

MUTUOIN3 -> media, somma (totale mutuo che viene erogato)
TDEBITA3 -> media, somma ()
media(TAEG3)
tasso medio ponderato = (sum(TAEG3)*MUTUOIN3)/sum(TAEG3)
groupby(DEB3)
```{r}
alld2_fam[is.na(alld2_fam)] <- 0
```

```{r}
alld2_fam$DEBM3 <- factor(alld2_fam$DEBM3,
                          levels = c(1, 2, 3, 4, 5),
                          labels = c("acquisto di mezzi di trasporto (come auto, moto)",
                                     "acquisto di altri beni durevoli (come elettronica, mobili, elettrodomestici, ecc.)",
                                     "acquisto di beni non durevoli (vacanze, ecc..)",
                                     "altri acquisti o spese quotidiane",
                                     "spese di istruzione (laurea, master)"))
```

TDEBITA3 = ammontare del debito residuo
MUTUOIN3 = importo iniziale del debito
#calcolo ratio TDEBITA3/MUTUOIN3
```{r}
alld2_fam %>% group_by(DEBM3) %>% summarize(n = n(),
                                            somma_mutuo3 = sum(MUTUOIN3),
                                            mean_mutuo3 = mean(MUTUOIN3),
                                            mean_tdebita3 = mean(TDEBITA3),
                                            somma_tdebita3 = sum(TDEBITA3),
                                            mean_taeg = mean(TAEG3),
                                            tasso_medio_ponderato_taeg =(sum(TAEG3*MUTUOIN3)/sum(MUTUOIN3))
                                            )
```
ripartizione del mutuo all'origine, tassi
tdebita3 = pfcons spaccato nelle 5 componenti
#da aggiungere sum(tdebita3)/sum(MUTUOIN3) = percentuale ancora da pagare
#durata media ponderata del mutuo

```{r}
alld2_fam$TIPOTAX3 <- factor(alld2_fam$TIPOTAX3,
                               levels = c(1, 2, 3),
                               labels = c('Fisso',
                                          'Variabile',
                                          'Zero'))
```

#apertura per TIPOTAX3 = Il tasso è fisso, variabile o zero?
```{r}
alld2_fam %>% group_by(TIPOTAX3) %>% summarize(n = n(),
                                            somma_mutuo3 = sum(MUTUOIN3),
                                            mean_mutuo3 = mean(MUTUOIN3),
                                            mean_tdebita3 = mean(TDEBITA3),
                                            somma_tdebita3 = sum(TDEBITA3),
                                            mean_taeg = mean(TAEG3),
                                            tasso_medio_ponderato =(sum(TAEG3*MUTUOIN3)/sum(MUTUOIN3))
                                            )
```

##DEBM3 (tipo di debito)
MUTUODU3 = Qual è la durata complessiva in anni del debito inizialmente stabilita?
#durata media in anni del debito inizialmente stabilita per tipo di debito
```{r}
alld2_fam %>% group_by(DEBM3) %>% summarize(mean_anni_durata_mutuo = mean(MUTUODU3))
```
# MUTUOIN3 = Qual era l’importo iniziale del debito?
```{r}
somma_mutuo = alld2_fam %>% group_by(NQUEST) %>% summarize(somma_mutuoin3 = sum(MUTUOIN3))
```

```{r}
debito = inner_join(debiti20, somma_mutuo, by = "NQUEST")
```

```{r}
carcom_tot = left_join(carcom20, debito, by = "NQUEST")
```

```{r}
carcom_tot$CLETA5 <- factor(carcom_tot$CLETA5,
                               levels = c(1, 2, 3, 4, 5),
                               labels = c('fino a 34 anni',
                                          '35-44',
                                          '45-54',
                                          '55-64',
                                          'oltre 64'))
```


#pecentuale per fascia età di richiedenti mutuo
```{r}
carcom_tot %>% 
  group_by(CLETA5) %>% 
  summarize(tot_richiesta_mutuo_count = sum(!is.na(somma_mutuoin3)), 
            tot_fascia_eta = n(), 
            tot_creditoconsumo_fascia_eta = tot_richiesta_mutuo_count / tot_fascia_eta,
            )
```
```{r}
carcom_tot$AREA5 <- factor(carcom_tot$AREA5,
                               levels = c(1, 2, 3, 4, 5),
                               labels = c('Nord Ovest',
                                          'Nord Est',
                                          'Centro',
                                          'Sud',
                                          'Isole'))
```

#percentuale per fascia età di richiedenti mutuo
(1=Nord Ovest, 2=Nord Est, 3=Centro, 4=Sud, 5=Isole)
```{r}
carcom_tot %>% 
  group_by(AREA5) %>% 
  summarize(mutuo_count = sum(!is.na(somma_mutuoin3)), 
            tot_fascia_eta = n(), 
            tot_creditoconsumo_fascia_eta = mutuo_count / tot_fascia_eta,
            )
```

##Disposable income analysis: debt to disposable income
```{r}
setwd("C:/Users/Alberto-PC/Downloads/ind20_ascii/CSV")
rfam20 <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/rfam20.csv", sep=",")
```

```{r}
sum(rfam20$Y)
```
##debito residuo su reddito 
```{r}
reddito_debito_res = left_join(carcom_tot, rfam20, by = "NQUEST")
```


```{r}
reddito_debito_res$CLETA5 <- factor(reddito_debito_res$CLETA5,
                               levels = c(1, 2, 3, 4, 5),
                               labels = c('fino a 34 anni',
                                          '35-44',
                                          '45-54',
                                          '55-64',
                                          'oltre 64'))
```


```{r}
reddito_debito_res %>% 
  group_by(CLETA5) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```
```{r}
reddito_debito_res %>% 
  group_by(NPERC) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```
```{r}
reddito_debito_res %>% 
  group_by(QUAL) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```
```{r}
reddito_debito_res %>% 
  group_by(QUAL) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```



# FOCUS 2 - TOTALE RATE PAGATE NEL 2020

Andiamo dunque a considerare il totale di rate pagate nel 2020 e facciamo qualche analisi. 

Potremmo andare a calcolare:

- la media delle rate pagate nel 2020

- distribuzione delle rate pagate nel 2020

- la suddivisione in res, aimm, fam, prof

- la distribuzione geografica

- vedere quanti hanno estinto il debito nel 2020 (=> cioè DEB RES = 0, mentre TOT RATE PAGATE NEL 2020 != 0) e capire che tipo di mutuo hanno estinto

- professione di persone che hanno estinto il debito ed età

- occupazione di quelli con rate + alte e di quelli con rate + basse

- numero componenti famiglia di chi ha rate + alte e + basse

 

### PERCENTUALE DI HOUSEHOLDS CON RATE NEL 2020
```{r}
# per prima cosa andiamo a sostituire i NaN con 0 e per calcolare quante persone hanno pagato delle rate nel 2020, facciamo il rapporto tra quelli che avevano tot_rate_pagate > 0 / (tot_rate_pagate = 0 + tot_rate_pagate != 0)

debiti$tot_rate_pagate[is.na(debiti$tot_rate_pagate)] = 0

si_rate = debiti$tot_rate_pagate[debiti$tot_rate_pagate > 0]

perc_rate_pagate = length(si_rate)/(length(debiti$tot_rate_pagate))*100
cat('Il totale di households che nel 2020 hanno pagato rate è:',perc_rate_pagate, '%')
```


### MEDIA DELLE RATE PAGATE NEL 2020


```{r}
# consideriamo poi soltanto i questionari con tot rate > 0

summary(si_rate)
```



### DISTRIBUZIONE DELLE RATE PAGATE NEL 2020

Possiamo utilizzare un istogramma e un qqplot per studiare la distribuzione delle rate pagate:

```{r}
rate_pagate = debiti %>% filter(tot_rate_pagate > 0) 

ggplot(rate_pagate, aes(x = tot_rate_pagate, y = ..density..)) +
  geom_histogram(col = 'purple', fill = 'lightpink') +
  scale_x_log10() +
  labs(title = 'Distribuzione rate pagate nel 2020', x = 'rate pagate', y = 'density')
```



### SUDDIVISIONE IN RES, AIMM, PROF, FAM
```{r}
# creiamo un dataset con la scomposizione delle rate pagate nel 2020

percentuali_dataset <- debiti %>% filter(tot_rate_pagate >0) %>%
  mutate(Perc_res = round((tot_rate_res / tot_rate_pagate) * 100, 1),
         Perc_fam = round((tot_rate_fam / tot_rate_pagate) * 100, 1),
         Perc_prof = round((tot_rate_professione / tot_rate_pagate) * 100, 1),
         Perc_aimm = round((tot_rate_altri_immobili / tot_rate_pagate) * 100, 1)) 

percentuali_dataset = percentuali_dataset %>% select(NQUEST, tot_rate_pagate, tot_rate_res, tot_rate_fam, tot_rate_professione, tot_rate_altri_immobili, Perc_res, Perc_fam, Perc_prof, Perc_aimm)

percentuali_dataset
```

```{r}
# andiamo a sommare i valori e vediamo com'è la scomposizione generale del totale rate pagate nel 2020

valore_res = round((sum(percentuali_dataset$tot_rate_res[percentuali_dataset$tot_rate_res > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

valore_fam = round((sum(percentuali_dataset$tot_rate_fam[percentuali_dataset$tot_rate_fam > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

valore_prof = round((sum(percentuali_dataset$tot_rate_professione[percentuali_dataset$tot_rate_professione > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

valore_aimm = round((sum(percentuali_dataset$tot_rate_altri_immobili[percentuali_dataset$tot_rate_altri_immobili > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

categoria = c('Res', 'Fam', 'Aimm', 'Prof')
valori = c(valore_res, valore_fam, valore_aimm, valore_prof)

dataframe = data.frame(categoria, valori)
dataframe
```

```{r}
# creaiamo un grafico a barre

ggplot(dataframe, aes(x = categoria, y = valori)) +
  geom_bar(stat = 'identity', fill = heat.colors(length(dataframe$categoria)))
```






