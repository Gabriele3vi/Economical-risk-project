---
title: "Economical risk project"
author: "Gabriele Trevisan"
date: "2024-02-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Economical risk project

# SETUP MAC
```{r}
setwd("~/Desktop/Economical-risk-project")
```

# SETUP WINDOWS
```{r}
# Qui dovete mettere il vostro path
# setwd("~\Desktop\Economical-risk-project")
```

## carico Tidyverse
```{r}
library(tidyverse)
```

## Caricamento dei dataset - MAC
```{r}
carcom = read.csv("indagine_2020/carcom20.csv")
debiti =  read.csv("indagine_2020/debiti20.csv")

# Carico gli allegati
debiti_residenza = read.csv("indagine_2020/alld2_res.csv")
debiti_professione = read.csv("indagine_2020/alld2_prof.csv")
debiti_famiglia = read.csv("indagine_2020/alld2_fam.csv")
debiti_altri_immobili = read.csv("indagine_2020/alld2_aimm.csv")
```


## Caricamento dei dataset - WINDOWS
```{r}

carcom = read.csv("indagine_2020\carcom20.csv")
debiti =  read.csv("indagine_2020\debiti20.csv")

# Carico gli allegati
debiti_residenza = read.csv("indagine_2020\alld2_res.csv")
debiti_professione = read.csv("indagine_2020\alld2_prof.csv")
debiti_famiglia = read.csv("indagine_2020\alld2_fam.csv")
debiti_altri_immobili = read.csv("indagine_2020\alld2_aimm.csv")
```


## Pulizia dei dataset
### Carcom
Teniamo solo le variabili che ci servono
```{r}
carcom = carcom %>% select(NQUEST, nord, NCOMP, SEX, ANASC, ETA, CLETA5, PERL, PERC, NPERL, NPERC, Q, QUAL, SETT, AREA5, IREG, ACOM4C)


carcom = carcom %>% rename("classe_eta" = CLETA5)
carcom$classe_eta = as.factor(carcom$classe_eta)

carcom = carcom %>% rename("anno_nascita" = ANASC)
carcom = carcom %>% rename("numero_componenti" = NCOMP)
carcom = carcom %>% rename("status_lavoratore" = Q)
carcom$status_lavoratore = as.factor(carcom$status_lavoratore)

carcom = carcom %>% rename("qualifica_lavoratore" = QUAL)
carcom$qualifica_lavoratore = as.factor(carcom$qualifica_lavoratore)

carcom = carcom %>% rename("settore" = SETT)
carcom$settore = as.factor(carcom$settore)

carcom = carcom %>% rename("area_geografica" = AREA5)
carcom$area_geografica = as.factor(carcom$area_geografica)

carcom = carcom %>% rename("regione_residenza" = IREG)
carcom$regione_residenza = as.factor(carcom$regione_residenza)

carcom = carcom %>% rename("ampiezza_comune" = ACOM4C)
carcom$ampiezza_comune = as.factor(carcom$ampiezza_comune)
```


### Debiti
Pulizia dataset debiti
```{r}
debiti = debiti %>% rename("tot_rate_pagate" = RATADEB)
debiti = debiti %>% rename("tot_rate_res" = RATADEB_RES)
debiti = debiti %>% rename("tot_rate_altri_immobili" = RATADEB_AIMM)
debiti = debiti %>% rename("tot_rate_fam" = RATADEB_FAM)
debiti = debiti %>% rename("tot_rate_professione" = RATADEB_PROF)
debiti = debiti %>% rename("deb_res_immobili" = PFIMM)
debiti = debiti %>% rename("deb_res_beni_consumo" = PFCONS)
debiti = debiti %>% rename("deb_res_mezzi_trasporto" = TDEBITC)
debiti = debiti %>% rename("deb_res_beni_durevoli" = TDEBITD)
debiti = debiti %>% rename("deb_res_beni_non_durevoli" = TDEBITE)
debiti = debiti %>% rename("deb_res_altro" = TDEBITF)
debiti = debiti %>% rename("deb_res_istruzione" = TDEBITG)
debiti = debiti %>% rename("deb_res_professione" = PFAZ)
debiti = debiti %>% rename("deb_carte_credito" = PFCARTE)
debiti = debiti %>% rename("deb_scoperto_cc" = PFCC)
debiti = debiti %>% rename("deb_garanzie_reali" = PFCOLL)
debiti = debiti %>% rename("deb_no_garanzie_reali" = PFNOCOLL)


# Setto a 0 i dati NA
debiti = replace(debiti, is.na(debiti), 0)
```



```{r}
regions_data = read.csv("codici_regioni_prov_comuni.csv", sep=";")
regions_data = regions_data %>% select(Codice.Regione, Denominazione.Regione, Ripartizione.geografica, Codice.Ripartizione.Geografica)
regions_data = distinct(regions_data)
regions_data = regions_data %>% rename("regione_residenza" = "Codice.Regione")
regions_data
```

# Analisi dati

Aggiungo una colonna chiamata "Totale debito" che è la somma di: 
  - Debito residuo per gli immobili 
  - "" per beni di consumo
  - "" della professione
  - "" delle carte di credito
  - "" dello scoperto di conto corrente
```{r}

debiti = debiti %>% mutate(tot_debito = deb_res_immobili + deb_res_beni_consumo + deb_res_professione + deb_carte_credito + deb_scoperto_cc)

print(paste("Debito totale famiglie italiane 2020 nel campione: ", sum(debiti$tot_debito)))
```

```{r}
famiglie_con_debito = debiti %>% filter(debiti$tot_debito > 0)

print(paste("Percentuale di famiglie con debiti:", nrow(famiglie_con_debito)/nrow(debiti) * 100))
```

Ora analizziamo com'è distribuito il debito tra le famiglie che sono indebitate

```{r}
summary(famiglie_con_debito$tot_debito)
```

```{r}
ggplot(famiglie_con_debito) +
  geom_histogram(aes(x = tot_debito))
```
```{r}
# Questo penso sia inutile
ggplot(famiglie_con_debito) +
  geom_boxplot(aes(x = tot_debito))
```



```{r}
ggplot(debiti) +
  geom_histogram(aes(x = tot_debito))
```
# Analisi sul debito e variabili sociodemografiche

In primis ci salviamo da carcom solo le variabili utili per essere analizzate col debito,
ed eliminiamo i doppioni 

```{r}
carcom_per_debito = carcom %>% select(NQUEST, numero_componenti, NPERC,area_geografica, regione_residenza, ampiezza_comune)

# ora elimino i duplicati dal dataframe
carcom_per_debito = distinct(carcom_per_debito)
```

Ora creo il dataframe facendo il join tra i carcom senza duplicati e debiti
```{r}
debiti_full = merge(carcom_per_debito, debiti, by="NQUEST")

head(debiti_full)
```

Proviamo a fare un analisi sul debito per area geografica
```{r}
debito_area_geografica = debiti_full %>% filter(tot_debito > 0) %>% group_by(area_geografica) %>% summarize(mean = mean(tot_debito), median = median(tot_debito), sd = sd(tot_debito)) %>% arrange(desc(mean))
debito_area_geografica
# Specify the path where you want to save the CSV file
file_path <- "debito_residuo_per_area_geografica.csv"

# Export the DataFrame to a CSV file
write.csv(debito_area_geografica, file = file_path, row.names = TRUE)
```

Proviamo a fare un analisi sul debito per regione di residenza
```{r}
debito_per_regione = debiti_full %>% filter(tot_debito > 0) %>% group_by(regione_residenza) %>% summarize(mean = mean(tot_debito), median = median(tot_debito), sd = sd(tot_debito)) %>% arrange(desc(mean))
debito_per_regione = merge(debito_per_regione, regions_data, by="regione_residenza")

ggplot(debito_per_regione) +
  geom_bar(aes(x = reorder(Denominazione.Regione, +median), y = median, fill = Ripartizione.geografica), stat="identity") +
  coord_flip() +
  labs(x = "Regione", y = "Debito residuo mediano per regione")


```

Proviamo a fare un analisi sul debito per ampiezza del comune di residenza
```{r}
debiti_full %>% filter(tot_debito > 0) %>% group_by(ampiezza_comune) %>% summarize(mean = mean(tot_debito), median = median(tot_debito), sd = sd(tot_debito)) %>% arrange(desc(mean))
```


Ora voglio vedere se c'è una correlazione tra il numero di percettori di reddito di una famiglia e il debito
```{r}
debiti_full = debiti_full %>% mutate(rapp_perc = NPERC/numero_componenti)

ggplot(debiti_full %>% filter(tot_debito > 0)) +
  geom_point(aes(x=rapp_perc, y = tot_debito))
```

```{r}
model = lm(tot_debito ~ rapp_perc, data = debiti_full %>% filter(tot_debito > 0))
summary(model)
```

Dalla regressione lineare possiamo vedere come il coefficiente di legato a rapp_perc abbia un p-value bello alto, quindi dobbiamo rigettare l'ipotesi che ci sia una correlazione tra numero di percettori di reddito dij una famiglia e il debito residuo



# Debiti con o senza garanzie reali
si parla sempre di debito residuo, è interessante vedere per ogni famiglia come è distribuita la quota del debito
```{r}
con_deb = debiti_full %>% filter(tot_debito > 0)
con_deb = con_deb %>% mutate(perc_gar_real = deb_garanzie_reali/tot_debito)
con_deb = con_deb %>% mutate(perc_gar_non_real = 1-perc_gar_real)

con_deb %>% select(NQUEST, perc_gar_real)

ggplot(con_deb) +
  geom_histogram(aes(x = perc_gar_real))
```

```{r}
summary(con_deb$perc_gar_real)
```

Assegno una classe alle famiglie che hanno praticamente solo debito con garanzie reali
```{r}
con_deb = con_deb %>% mutate(gar_real = ifelse(perc_gar_real > 0.75, 1, 0)) 

con_deb %>% group_by(gar_real) %>% summarize(count = n())

tipo = con_deb %>% select(NQUEST, gar_real)

hs_eta = carcom %>% group_by(NQUEST) %>% summarize(eta_media = mean(ETA))
con_deb = merge(con_deb, hs_eta, by="NQUEST")
```

```{r}
ggplot(con_deb) +
  geom_point(aes(x = eta_media, y = tot_debito)) +
  scale_y_log10()
```
Da questo grafico possiamo dire che tendenzialmente non c'è una correlazione tra eta media e debito residuo, ma forse possiamo dire che 



```{r}
ggplot(con_deb) +
  geom_point(aes(x = eta_media, y = gar_real)) 
```


 L'età non è nemmeno un indicatore di debito con garanzie reali o no
 
```{r}
#Vediamo se a livello geografico c'è una qualche differenza  tra chi ah debiti con garanzie reali e chi no

perc_gar_real_reg = con_deb %>% group_by(regione_residenza) %>% summarize(perc_con_gar_real = sum(gar_real)/n()) %>% arrange(desc(perc_con_gar_real))
perc_gar_real_reg
```
 Sono risultati interessanti, facciamo un barplot associando le etichette delle regioni
 
```{r}
perc_gar_real_reg = merge(perc_gar_real_reg, regions_data, by="regione_residenza")
perc_gar_real_reg

```

Faccio il grafico
```{r}
ggplot(perc_gar_real_reg) +
  geom_bar(aes(x = reorder(Denominazione.Regione, +perc_con_gar_real), y = perc_con_gar_real, fill = Ripartizione.geografica), stat="identity") +
  coord_flip() +
  labs(x = "Regione", y = "% di debiti con garanzie reali sul totale ")
```
 
 
```{r}
con_deb
```
 


# ANALISI COMPONENTI DEL DEBITO RESIDUO

## PFIMM

= indica il debito residuo per acquisto/ristrutturazione immobili

Quante households hanno ancora debito residuo per acquisto/ristrutturazione immobili?

```{r}
tot_fam_NO_PFIMM = sum(debiti$deb_res_immobili == 0)
cat('Il totale delle households senza PFIMM è: ', tot_fam_NO_PFIMM, '\n')

tot_fam_PFIMM = sum(debiti$deb_res_immobili > 0)
cat('Il totale delle households con PFIMM è: ', tot_fam_PFIMM, '\n')

cat('La percentuale di households che nel 2020 presentano debito residuo per acquisto/ristrutturazione immobili è: ', (tot_fam_PFIMM/(tot_fam_NO_PFIMM+tot_fam_PFIMM))*100,'%', '\n')
```

Delle households con PFIMM, presentiamo un riassunto statistico di media, mediana, quartili, valore minimo, valore massimo:
```{r}
pfimm = debiti %>% select(deb_res_immobili) %>% filter(deb_res_immobili != 0) 
summary(pfimm)
```
Guardiamo la distribuzione di questi valori attraverso l'utilizzo di un'istogramma:

```{r}
library(ggplot2)

ggplot(pfimm, aes(x = deb_res_immobili, y = ..density..)) + 
  geom_histogram(bins = 60) + 
  geom_vline(xintercept = median(pfimm$deb_res_immobili), color = 'red') + 
  geom_vline(xintercept = mean(pfimm$deb_res_immobili), color = 'green')
```
Possiamo vedere come la distribuzione dei valori del debito residuo per acquisto/ristrutturazione immobili non sia normale, ma right-skewed, dal momento che la media ha un valore superiore della mediana.

Ora possiamo anche utilizzare un boxplot per avere una situazione più chiara:

```{r}
# UTILE?

ggplot(pfimm, aes(x = pfimm$deb_res_immobili)) +
  geom_boxplot()
```

### Analisi sul debito e variabili sociodemografiche

In primis ci salviamo da carcom solo le variabili utili per essere analizzate col debito, ed eliminiamo i doppioni:

```{r}
carcom_per_debito = carcom %>% select(NQUEST, numero_componenti, area_geografica, regione_residenza, ampiezza_comune)

# ora elimino i duplicati dal dataframe
carcom_per_debito = distinct(carcom_per_debito)
```

Ora creo il dataframe facendo il join tra i carcom senza duplicati e debiti:
```{r}
debiti_full = merge(carcom_per_debito, debiti, by="NQUEST")

head(debiti_full)
```

In relazione a:

### NUMERO COMPONENTI


```{r}

# Qui ci sta lasciare la mediana invece della media
pfimm_n_componenti = debiti_full %>% filter(deb_res_immobili > 0) %>% group_by(numero_componenti) %>% summarize(mean = mean(deb_res_immobili), median = median(deb_res_immobili), sd = sd(deb_res_immobili)) %>% arrange()

ggplot(pfimm_n_componenti, aes(x = numero_componenti, y = median)) +
  geom_bar(stat = "identity", fill = "skyblue", color = "black") +
  labs(title = "Mediana del debito residuo per numero di componenti",
       x = "Numero di componenti",
       y = "Media del debito residuo") 

# Perchè qua ho NA su sd?
```

### AREA GEOGRAFICA
```{r}
pfimm_area_geografica = debiti_full %>% filter(deb_res_immobili > 0) %>% group_by(area_geografica) %>% summarize(mean = mean(deb_res_immobili), median = median(deb_res_immobili), sd = sd(deb_res_immobili)) %>% arrange()
pfimm_area_geografica
```

```{r}
etichette_aree = c('Nord-Ovest', 'Nord-Est', 'Centro', 'Sud', 'Isole')
ggplot(pfimm_area_geografica, aes(x = area_geografica, y = "", fill = mean)) +
  geom_tile() +
  scale_fill_gradient(low = "lightgreen", high = "darkgreen") +
  scale_x_discrete(labels = etichette_aree)
```

### REGIONE DI RESIDENZA

```{r}
debiti_full %>% filter(deb_res_immobili > 0) %>% group_by(regione_residenza) %>% summarize(mean = mean(deb_res_immobili), median = median(deb_res_immobili), sd = sd(deb_res_immobili)) %>% arrange(desc(mean)) 
```

## PFAZ

= indica il debito residuo per motivi professionali

Quante households presentano debito residuo nel 2020?
```{r}
tot_fam_NO_PFAZ = sum(debiti$deb_res_professione == 0) 
cat('Il totale delle households senza PFAZ è:', tot_fam_NO_PFAZ, '\n')

tot_fam_PFAZ = sum(debiti$deb_res_professione > 0) 
cat('Il totale delle households con PFAZ è:', tot_fam_PFAZ, '\n')

cat('La percentuale di households che nel 2020 presentano debito residuo per motivi professionali è:', (tot_fam_PFAZ/(tot_fam_NO_PFAZ+tot_fam_PFAZ))*100,'%', '\n')
```
Delle households con PFAZ presentiamo un riassunto statistico di media, mediana, quartili, valore minimo, valore massimo:
```{r}
pfaz = debiti %>% select(deb_res_professione) %>% filter(deb_res_professione != 0) 
summary(pfaz)
```
Guardiamo la distribuzione di questi valori attraverso l'utilizzo di un'istogramma:

```{r}
library(ggplot2)  

ggplot(pfaz, aes(x = deb_res_professione)) +
  geom_histogram(bins = 30) + 
  geom_vline(xintercept = median(pfaz$deb_res_professione), color = 'red') +
  geom_vline(xintercept = mean(pfaz$deb_res_professione), color = 'green') +
  scale_x_log10()
```
Provo a vedere se i debiti res professione sono normali come sembrano



### Analisi sul debito e variabili sociodemografiche
In primis ci salviamo da carcom solo le variabili utili per essere analizzate col debito, ed eliminiamo i doppioni.

```{r}
carcom_pfaz = carcom %>% select(NQUEST, classe_eta, numero_componenti, PERL, NPERL, status_lavoratore, qualifica_lavoratore, settore, area_geografica)

carcom_pfaz = distinct(carcom_pfaz)

```

Ora facciamo il merge tra i due dataset

```{r}
debiti_pfaz = merge(carcom_pfaz,debiti, by = "NQUEST")
debiti_pfaz %>% select(NQUEST, qualifica_lavoratore,deb_res_professione) %>% filter(deb_res_professione > 0) %>%arrange(desc(NQUEST))

```


### STATUS LAVORATORE
```{r}
pfaz_status = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(status_lavoratore) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange()
```

```{r}
etichette = c('1 - Employee', '2 - Self-employed', '3 - Non-Professional')
colori = c('darkorange', 'darkred', 'darkblue')
ggplot(pfaz_status, aes(x = status_lavoratore, y = mean)) +
  geom_bar(stat = 'identity', fill = colori) +
  scale_x_discrete(labels = etichette)
```

### QUALIFICA
```{r}
#Quqesto forse meh
pfaz_qual = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(qualifica_lavoratore) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange() %>% mutate('Qualifica' = c('operaio', 'impiegato', 'dirigente', 'imprenditore/libero professionista', 'altro autonomo', 'pensionato', 'altro non occupato')) %>% select(Qualifica, everything())

colori = c('lightgreen', 'lightblue', 'lightpink', 'yellow', 'darkorange', 'red', 'darkblue')
pie(pfaz_qual$mean, labels = pfaz_qual$Qualifica, col = colori)
```
### SETTORE

```{r}
pfaz_sett = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(settore)%>% mutate(Settore = case_when(
    settore == 1 ~ "Agricoltura",
    settore == 2 ~ "Industria",
    settore == 3 ~ "Servizi Pubblici",
    settore == 4 ~ "Altri settori",
    settore == 5 ~ "Nessun settore")) %>% select(Settore, everything())

pfaz_sett_summarize = pfaz_sett %>% filter(deb_res_professione > 0) %>% group_by(settore) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange()

ggplot(pfaz_sett, aes(x = Settore, y = deb_res_professione)) +
  geom_boxplot() +
  scale_y_log10()
```

### AREA GEOGRAFICA
```{r}
pfaz_area_geografica = debiti_pfaz %>% filter(deb_res_professione > 0) %>% group_by(area_geografica) %>% summarize(mean = mean(deb_res_professione), median = median(deb_res_professione), sd = sd(deb_res_professione)) %>% arrange()

etichette_aree = c('Nord-Ovest', 'Nord-Est', 'Centro', 'Sud', 'Isole')
ggplot(pfaz_area_geografica, aes(x = area_geografica, y = "", fill = mean)) +
  geom_tile() +
  scale_fill_gradient(low = "lightyellow", high = "darkorange") +
  scale_x_discrete(labels = etichette_aree)
```
## PFCARTE
= indica il debito su carte di credito

Quante households presentano nel 2020 debito su carte di credito

```{r}
debiti$deb_carte_credito <- replace(debiti$deb_carte_credito, is.na(debiti$deb_carte_credito), 0)

tot_fam_NO_PFCARTE = sum(debiti$deb_carte_credito == 0)
cat('Il totale di household senza PFCARTE è: ', tot_fam_NO_PFCARTE, '\n')

tot_fam_PFCARTE = sum(debiti$deb_carte_credito > 0)
cat('Il totale di household con PFCARTE è: ', tot_fam_PFCARTE, '\n')

cat('La percentuale di household con debito su carte di credito è: ', (tot_fam_PFCARTE/(tot_fam_NO_PFCARTE + tot_fam_PFCARTE))*100,'%', '\n')
```
```{r}
#Ha senso fare un'analisi considerando le variabili di carcom dal momento che abbiamo 47 households con debito su carta di credito????
```

## PFCC
= indica lo scoperto su conti correnti

Quante households presentano nel 2020 scoperto su conti correnti?
```{r}
debiti$deb_scoperto_cc <- replace(debiti$deb_scoperto_cc, is.na(debiti$deb_scoperto_cc), 0)

tot_fam_NO_PFCC = sum(debiti$deb_scoperto_cc == 0)
cat('Il totale di household senza PFCC è: ', tot_fam_NO_PFCC, '\n')

tot_fam_PFCC = sum(debiti$deb_scoperto_cc > 0)
cat('Il totale di household con PFCC è: ', tot_fam_PFCC, '\n')

cat('La percentuale di household con debito su carte di credito è: ', (tot_fam_PFCC/(tot_fam_NO_PFCC + tot_fam_PFCC))*100,'%', '\n')
```
Analizziamo la distribuzione dei dati attraverso un istogramma:

```{r}
deb_scoperto = debiti %>% filter(deb_scoperto_cc > 0) 
ggplot(deb_scoperto, aes(x = deb_scoperto_cc)) +
  geom_histogram(bins = 30) +
  geom_vline(xintercept = mean(deb_scoperto$deb_scoperto_cc), color = 'green') +
  geom_vline(xintercept = median(deb_scoperto$deb_scoperto_cc), color = 'red')
```


# Economical risk project
```{r}
# Qui dovete mettere il vostro path
setwd("C:\\Users\\Alberto-PC\\Downloads\\ind20_ascii\\CSV")
```

## carico Tidyverse
```{r}
library(tidyverse)
```

```{r}
carcom20 <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/carcom20.csv", sep=";")
debiti20 <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/debiti20.csv", sep=";")
alld2_res <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_res.csv", sep=";")
alld2_prof <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_prof.csv", sep=";")
alld2_fam <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_fam.csv", sep=";")
alld2_aimm <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/alld2_aimm.csv", sep=";")
```

TDEBITC (mezzi di trasporto), TDEBITD (beni durevoli), TDEBITE (beni non durevoli), TDEBITF (altri acquisti o spese quotidiane), TDEBITG (spese di istruzione)
```{r}
debiti20
```

##PCONS - Distribuzione per componente
#Analisi componenti debito residuo per acquisto beni di consumo rispetto varie voci (trasporto, beni durevoli, beni non durevoli, altri acquisti/spese quotidiane, istruzione:
```{r}
percent_residual_debt_transportation <- sum(debiti20$TDEBITC, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_durable <- sum(debiti20$TDEBITD, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_nondurable <- sum(debiti20$TDEBITE, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_other_everydayexpenses <- sum(debiti20$TDEBITF, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)
percent_residual_debt_education <- sum(debiti20$TDEBITG, na.rm = TRUE) / sum(debiti20$PFCONS, na.rm = TRUE)

perc <- data.frame(
  "Percent_residual_debt" = c(
    "Transportation" = percent_residual_debt_transportation,
    "Durable" = percent_residual_debt_durable,
    "Non-durable" = percent_residual_debt_nondurable,
    "Other Everyday Expenses" = percent_residual_debt_other_everydayexpenses,
    "Education" = percent_residual_debt_education))
print(perc)
```

```{r}
percentages <- c(
  "Transportation" = percent_residual_debt_transportation,
  "Durable" = percent_residual_debt_durable,
  "Non-durable" = percent_residual_debt_nondurable,
  "Other Everyday Expenses" = percent_residual_debt_other_everydayexpenses,
  "Education" = percent_residual_debt_education)

df <- data.frame(
  group = names(percentages),
  value = percentages)

pie_chart <- ggplot(df, aes(x = "", y = value, fill = group)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  ggtitle("Percentage of Residual Debt by Category") +
  theme_void()
print(pie_chart)
```


#ATTENZIONE QUI NO DISTINCT
#Seleziono informazioni secondo CFCRED = 1 (capofamiglia con maggiore reddito):
```{r}
carcom20 = filter(carcom20, CFRED == 1)
```

MUTUOIN3 -> media, somma (totale mutuo che viene erogato)
TDEBITA3 -> media, somma ()
media(TAEG3)
tasso medio ponderato = (sum(TAEG3)*MUTUOIN3)/sum(TAEG3)
groupby(DEB3)
```{r}
alld2_fam[is.na(alld2_fam)] <- 0
```

```{r}
alld2_fam$DEBM3 <- factor(alld2_fam$DEBM3,
                          levels = c(1, 2, 3, 4, 5),
                          labels = c("acquisto di mezzi di trasporto (come auto, moto)",
                                     "acquisto di altri beni durevoli (come elettronica, mobili, elettrodomestici, ecc.)",
                                     "acquisto di beni non durevoli (vacanze, ecc..)",
                                     "altri acquisti o spese quotidiane",
                                     "spese di istruzione (laurea, master)"))
```

TDEBITA3 = ammontare del debito residuo
MUTUOIN3 = importo iniziale del debito
#calcolo ratio TDEBITA3/MUTUOIN3
```{r}
alld2_fam %>% group_by(DEBM3) %>% summarize(n = n(),
                                            somma_mutuo3 = sum(MUTUOIN3),
                                            mean_mutuo3 = mean(MUTUOIN3),
                                            mean_tdebita3 = mean(TDEBITA3),
                                            somma_tdebita3 = sum(TDEBITA3),
                                            mean_taeg = mean(TAEG3),
                                            tasso_medio_ponderato_taeg =(sum(TAEG3*MUTUOIN3)/sum(MUTUOIN3))
                                            )
```
ripartizione del mutuo all'origine, tassi
tdebita3 = pfcons spaccato nelle 5 componenti
#da aggiungere sum(tdebita3)/sum(MUTUOIN3) = percentuale ancora da pagare
#durata media ponderata del mutuo

```{r}
alld2_fam$TIPOTAX3 <- factor(alld2_fam$TIPOTAX3,
                               levels = c(1, 2, 3),
                               labels = c('Fisso',
                                          'Variabile',
                                          'Zero'))
```

#apertura per TIPOTAX3 = Il tasso è fisso, variabile o zero?
```{r}
alld2_fam %>% group_by(TIPOTAX3) %>% summarize(n = n(),
                                            somma_mutuo3 = sum(MUTUOIN3),
                                            mean_mutuo3 = mean(MUTUOIN3),
                                            mean_tdebita3 = mean(TDEBITA3),
                                            somma_tdebita3 = sum(TDEBITA3),
                                            mean_taeg = mean(TAEG3),
                                            tasso_medio_ponderato =(sum(TAEG3*MUTUOIN3)/sum(MUTUOIN3))
                                            )
```

##DEBM3 (tipo di debito)
MUTUODU3 = Qual è la durata complessiva in anni del debito inizialmente stabilita?
#durata media in anni del debito inizialmente stabilita per tipo di debito
```{r}
alld2_fam %>% group_by(DEBM3) %>% summarize(mean_anni_durata_mutuo = mean(MUTUODU3))
```
# MUTUOIN3 = Qual era l’importo iniziale del debito?
```{r}
somma_mutuo = alld2_fam %>% group_by(NQUEST) %>% summarize(somma_mutuoin3 = sum(MUTUOIN3))
```

```{r}
debito = inner_join(debiti20, somma_mutuo, by = "NQUEST")
```

```{r}
carcom_tot = left_join(carcom20, debito, by = "NQUEST")
```

```{r}
carcom_tot$CLETA5 <- factor(carcom_tot$CLETA5,
                               levels = c(1, 2, 3, 4, 5),
                               labels = c('fino a 34 anni',
                                          '35-44',
                                          '45-54',
                                          '55-64',
                                          'oltre 64'))
```


#pecentuale per fascia età di richiedenti mutuo
```{r}
carcom_tot %>% 
  group_by(CLETA5) %>% 
  summarize(tot_richiesta_mutuo_count = sum(!is.na(somma_mutuoin3)), 
            tot_fascia_eta = n(), 
            tot_creditoconsumo_fascia_eta = tot_richiesta_mutuo_count / tot_fascia_eta,
            )
```
```{r}
carcom_tot$AREA5 <- factor(carcom_tot$AREA5,
                               levels = c(1, 2, 3, 4, 5),
                               labels = c('Nord Ovest',
                                          'Nord Est',
                                          'Centro',
                                          'Sud',
                                          'Isole'))
```

#percentuale per fascia età di richiedenti mutuo
(1=Nord Ovest, 2=Nord Est, 3=Centro, 4=Sud, 5=Isole)
```{r}
carcom_tot %>% 
  group_by(AREA5) %>% 
  summarize(mutuo_count = sum(!is.na(somma_mutuoin3)), 
            tot_fascia_eta = n(), 
            tot_creditoconsumo_fascia_eta = mutuo_count / tot_fascia_eta,
            )
```

##Disposable income analysis: debt to disposable income
```{r}
setwd("C:/Users/Alberto-PC/Downloads/ind20_ascii/CSV")
rfam20 <- read.csv("~/GitHub/Economical-risk-project/Indagine_2020/rfam20.csv", sep=",")
```

```{r}
sum(rfam20$Y)
```
##debito residuo su reddito 
```{r}
reddito_debito_res = left_join(carcom_tot, rfam20, by = "NQUEST")
```


```{r}
reddito_debito_res$CLETA5 <- factor(reddito_debito_res$CLETA5,
                               levels = c(1, 2, 3, 4, 5),
                               labels = c('fino a 34 anni',
                                          '35-44',
                                          '45-54',
                                          '55-64',
                                          'oltre 64'))
```


```{r}
reddito_debito_res %>% 
  group_by(CLETA5) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```
```{r}
reddito_debito_res %>% 
  group_by(NPERC) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```
```{r}
reddito_debito_res %>% 
  group_by(QUAL) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```
```{r}
reddito_debito_res %>% 
  group_by(QUAL) %>% 
  summarize(somma_deb_res_fascia = sum(PFCONS, na.rm = T),
            income_tot = sum(Y, na.rm = T),
            debt_to_disposable_income = somma_deb_res_fascia / income_tot,
            )
```



# FOCUS 2 - TOTALE RATE PAGATE NEL 2020

Andiamo dunque a considerare il totale di rate pagate nel 2020 e facciamo qualche analisi. 

Potremmo andare a calcolare:

- la media delle rate pagate nel 2020

- distribuzione delle rate pagate nel 2020

- la suddivisione in res, aimm, fam, prof

- la distribuzione geografica

- vedere quanti hanno estinto il debito nel 2020 (=> cioè DEB RES = 0, mentre TOT RATE PAGATE NEL 2020 != 0) e capire che tipo di mutuo hanno estinto

- professione di persone che hanno estinto il debito ed età

- occupazione di quelli con rate + alte e di quelli con rate + basse

- numero componenti famiglia di chi ha rate + alte e + basse

 

### PERCENTUALE DI HOUSEHOLDS CON RATE NEL 2020
```{r}
# per prima cosa andiamo a sostituire i NaN con 0 e per calcolare quante persone hanno pagato delle rate nel 2020, facciamo il rapporto tra quelli che avevano tot_rate_pagate > 0 / (tot_rate_pagate = 0 + tot_rate_pagate != 0)

debiti$tot_rate_pagate[is.na(debiti$tot_rate_pagate)] = 0

si_rate = debiti$tot_rate_pagate[debiti$tot_rate_pagate > 0]

perc_rate_pagate = length(si_rate)/(length(debiti$tot_rate_pagate))*100
cat('Il totale di households che nel 2020 hanno pagato rate è:',perc_rate_pagate, '%')
```


### MEDIA DELLE RATE PAGATE NEL 2020


```{r}
# consideriamo poi soltanto i questionari con tot rate > 0

summary(si_rate)
```



### DISTRIBUZIONE DELLE RATE PAGATE NEL 2020

Possiamo utilizzare un istogramma e un qqplot per studiare la distribuzione delle rate pagate:

```{r}
rate_pagate = debiti %>% filter(tot_rate_pagate > 0) 

ggplot(rate_pagate, aes(x = tot_rate_pagate, y = ..density..)) +
  geom_histogram(col = 'purple', fill = 'lightpink') +
  scale_x_log10() +
  labs(title = 'Distribuzione rate pagate nel 2020', x = 'rate pagate', y = 'density')
```



### SUDDIVISIONE IN RES, AIMM, PROF, FAM
```{r}
# creiamo un dataset con la scomposizione delle rate pagate nel 2020

percentuali_dataset <- debiti %>% filter(tot_rate_pagate >0) %>%
  mutate(Perc_res = round((tot_rate_res / tot_rate_pagate) * 100, 1),
         Perc_fam = round((tot_rate_fam / tot_rate_pagate) * 100, 1),
         Perc_prof = round((tot_rate_professione / tot_rate_pagate) * 100, 1),
         Perc_aimm = round((tot_rate_altri_immobili / tot_rate_pagate) * 100, 1)) 

percentuali_dataset = percentuali_dataset %>% select(NQUEST, tot_rate_pagate, tot_rate_res, tot_rate_fam, tot_rate_professione, tot_rate_altri_immobili, Perc_res, Perc_fam, Perc_prof, Perc_aimm)

percentuali_dataset
```

```{r}
# andiamo a sommare i valori e vediamo com'è la scomposizione generale del totale rate pagate nel 2020

valore_res = round((sum(percentuali_dataset$tot_rate_res[percentuali_dataset$tot_rate_res > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

valore_fam = round((sum(percentuali_dataset$tot_rate_fam[percentuali_dataset$tot_rate_fam > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

valore_prof = round((sum(percentuali_dataset$tot_rate_professione[percentuali_dataset$tot_rate_professione > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

valore_aimm = round((sum(percentuali_dataset$tot_rate_altri_immobili[percentuali_dataset$tot_rate_altri_immobili > 0]) / sum(percentuali_dataset$tot_rate_pagate[percentuali_dataset$tot_rate_pagate > 0])) *100, 2)

categoria = c('Res', 'Fam', 'Aimm', 'Prof')
valori = c(valore_res, valore_fam, valore_aimm, valore_prof)

dataframe = data.frame(categoria, valori)
dataframe
```

```{r}
# creaiamo un grafico a barre

ggplot(dataframe, aes(x = categoria, y = valori)) +
  geom_bar(stat = 'identity', fill = heat.colors(length(dataframe$categoria)))
```


###################################################

```{r}
TOT <- read.csv("E:/Dati_al_10.03.2024/Fam_Comp_Completo_PESOFIT/Fam_Comp_Completo_PESOFIT.csv", sep =";")
```

```{r}
TOT[is.na(TOT)] <- 0
TOT = TOT %>% filter(CFRED == 1)
```

```{r}
TOT %>% reframe(sum(PFIMM_pond) , sum(PFCONS_pond), sum(PFAZ_pond), sum(PFCARTE_pond), sum(PFCC_pond), sum(PF3_pond))
```

```{r}
library(ggplot2)
library(dplyr)


data <- data.frame(
  group=c("Residual debt for real estate purchase/renovation", "Residual debt for consumer goods purchase", "Residual debt for professional reasons", "Credit card debt", "Overdraft on current accounts", "Debts owed to other families"
),
  value=c(106142886, 5311779, 22007891, 213081.2, 1228045, 2768980)
)


ggplot(data, aes(x="", y=value, fill=group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
 
  theme_void() +
  labs(fill = "Type of Debt") +
  ggtitle("Total debt by type")
```
#### SPACCATURA PFCONS
```{r}
PFCONS <- read.csv("E:/Dati_al_12.03.2024/Unico_x_export_2020.csv", sep =";")
```

```{r}
PFCONS = PFCONS %>% filter(Variabile == "SEX") %>% summarise(sum(sum_TDEBITA3_1_pond), sum(sum_TDEBITA3_2_pond), sum(sum_TDEBITA3_3_pond), sum(sum_TDEBITA3_4_pond), sum(sum_TDEBITA3_5_pond))
```


```{r}
library(ggplot2)
library(dplyr)


data <- data.frame(
  group=c("acquisto di mezzi di trasporto (come auto, moto)", "l'acquisto di altri beni durevoli (come elettronica, mobili, elettrodomestici, ecc.)", "l'acquisto di beni non durevoli (vacanze, ecc..)", "altri acquisti o spese quotidiane", "spese di istruzione (laurea, master)"
),
  value=c(3937130, 342597.3, 15099.69, 983277.5, 33674.36)
)


ggplot(data, aes(x="", y=value, fill=group)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
 
  theme_void() +
  labs(fill = "Source of family needs debt") +
  ggtitle("Family needs debt")
```
##Analysis based on characteristics of household head of the family
```{r}
TOT <- read.csv("E:/Dati_al_12.03.2024/Unico_x_export_2020.csv", sep =";")
```


```{r}
SEX = TOT %>% filter(Variabile == "SEX")
STUDIO = TOT %>% filter(Variabile == "STUDIO")
SETT = TOT %>% filter(Variabile == "SETT")
IREG = TOT %>% filter(Variabile == "IREG")
ACOM5 = TOT %>% filter(Variabile == "ACOM5")
QUAL = TOT %>% filter(Variabile == "QUAL")
AREA5 = TOT %>% filter(Variabile == "AREA5")
CLETA5 = TOT %>% filter(Variabile == "CLETA5")
Q = TOT %>% filter(Variabile == "Q")
```

```{r}
SEX$Modalita <- factor(SEX$Modalita,
                  levels = c(1, 2),
                  labels = c("uomo",
                             "donna"))
SEX
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
SEX %>% reframe("Sex" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond), "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond), "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond), "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond), "PFCC" = (sum_PFCC_pond/Deb_tot_pond), "PF3" = (sum_PF3_pond/Deb_tot_pond))
```
```{r}
df <- data.frame(
  Sex = c("uomo", "donna"),
  PFIMM = c(0.7746514, 0.7600687),
  PFCONS = c(0.03985737, 0.03479411),
  PFAZ = c(0.1527394, 0.1810098),
  PFCARTE = c(0.001225747	, 0.002504731),
  PFCC = c(0.00824720, 0.01091977),
  PF3 = c(0.02327884, 0.01070290)
)

library(ggplot2)
library(tidyr)

df_melted <- pivot_longer(df, cols = -Sex, names_to = "Debt_Category", values_to = "Percentage")


ggplot(df_melted, aes(x = Sex, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Sex",
       x = "Sex",
       y = "Percentage") +
  theme_minimal() +
  theme(legend.position = "top", legend.title = element_blank())

```

```{r}
SEX %>% reframe("Sex" = Modalita, "Indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```

```{r}
SEX %>% reframe("Sex" = Modalita, "Average value of debt" = Deb_tot_pond/n_indeb_compl_pond, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
SEX %>% reframe("Sex" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```

```{r}
library(kableExtra)

df <- data.frame(
  Sex = c("uomo", "donna"),
  `Average duration (years)` = c(24.74079, 25.00805),
  `Average number of suspensions` = c(8642583, 5362088),
  `Average duration (years)` = c(20.32436, 21.10711),
  `Average number of suspensions` = c(965599.4, 143725.2),
  `Average duration (years)` = c(6.782009, 5.208879),
  `Average number of suspensions` = c(326317.8, 137497.3),
  `Average duration (years)` = c(14.34644, 18.40671),
  `Average number of suspensions` = c(0, 0)
)

kbl(df) %>%
  kable_classic() %>%
  add_header_above(c(" " = 1, 
                     "Indebtedness for primary residence" = 2, 
                     "Indebtedness for other properties" = 2, 
                     "Other debts for family needs" = 2, 
                     "Debts for professional activity" = 2))

```
LOAN to VALUE = valore del prestito sul valore ipoteca (su mutuo) [quanta parte è garantita]
Lenders use the LTV ratio to assess the risk of providing a mortgage loan. A higher LTV ratio indicates that the borrower has less equity in the property and therefore represents a higher risk for the lender.

```{r}
SEX %>% reframe("Sex" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```


#INDEBITAMENTO PER L’ABITAZIONE DI RESIDENZA
```{r}
STUDIO$Modalita <- factor(STUDIO$Modalita,
                  levels = c(1, 2, 3, 4, 5, 6, 7, 8),
                  labels = c("nessuno",
                             "licenza elementare",
                             "licenza media inferiore",
                             "diploma professionale (3 anni)",
                             "diploma media superiore",
                             "dipl. universitario/laurea triennale",
                             "laurea/laurea magistrale",
                             "specializzazione post-laurea"))
STUDIO
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
STUDIO %>% reframe("Education level" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Education_Level = c("nessuno", "licenza elementare", "licenza media inferiore", "diploma professionale (3 anni)",
                      "diploma media superiore", "dipl. universitario/laurea triennale", "laurea/laurea magistrale",
                      "specializzazione post-laurea"),
  PFIMM = c(61.42582, 23.23732, 65.04393, 72.29478, 77.09452, 93.78598, 85.71742, 79.95396),
  PFCONS = c(33.079744, 7.093515, 4.616621, 8.209274, 4.352642, 3.082913, 2.170529, 3.262515),
  PFAZ = c(0.000000, 65.805344, 25.670433, 14.721823, 15.321474, 2.790856, 10.526677, 12.165594),
  PFCARTE = c(0.00000000, 0.03980068, 0.34211301, 0.20263760, 0.15175451, 0.11748142, 0.10510372, 0.03500135),
  PFCC = c(0.00000000, 1.01084865, 1.12420714, 2.18672241, 0.87447723, 0.07084037, 0.74497769, 0.73917019)
)

library(tidyr)
df_long <- pivot_longer(df, cols = -Education_Level, names_to = "Debt_Category", values_to = "Percentage")

ggplot(df_long, aes(x = Education_Level, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Education Level",
       x = "Education Level",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
### number of individuals indebted
```{r}
STUDIO %>% reframe("Education level" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```

```{r}
STUDIO %>% reframe("Education level" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
STUDIO %>% reframe("Education level" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```

```{r}
library(kableExtra)

df <- data.frame(
  "Education level" = c("nessuno",
                             "licenza elementare",
                             "licenza media inferiore",
                             "diploma professionale (3 anni)",
                             "diploma media superiore",
                             "dipl. universitario/laurea triennale",
                             "laurea/laurea magistrale",
                             "specializzazione post-laurea"),
  `Average duration (years)` = c(NA	, 19.91693, 24.25278, 22.74181, 25.29877, 25.03328, 25.44377, 23.18122),
  `Average number of suspensions` = c(NA, 174690.1, 3735612.6, 926370.7, 6021416.5, 260531.2, 2408656.6, 477392.9),
  `Average duration (years)` = c(10.00000, 30.00000, 19.69857, 15.67482, 19.87938, 25.89786, 20.80761, 21.27390),
  `Average number of suspensions` = c(0.0	,0.0	,170701.5	,0.0	,285790.7	,516273.3	,136559.2	,0.0),
  `Average duration (years)` = c(5.480884	,6.925460	,6.325834	,5.810517	,7.249216	,8.309512	,5.540637	,3.991714),
  `Average number of suspensions` = c(83.46872	,0.00000	,115729.25184	,124692.23499	,199442.53372	,0.00000	,23867.65474	,0.00000),
  `Average duration (years)` = c(NA,21.590374,14.503737,9.401955,16.236751,4.229959,13.105538,16.305055),
  `Average number of suspensions` = c(0, 0, 0, 0, 0, 0, 0, 0)
)

kbl(df) %>%
  kable_classic() %>%
  add_header_above(c(" " = 1, 
                     "Indebtedness for primary residence" = 2, 
                     "Indebtedness for other properties" = 2, 
                     "Other debts for family needs" = 2, 
                     "Debts for professional activity" = 2))

```
```{r}
STUDIO %>% reframe("Education level" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```

```{r}
STUDIO %>% reframe("Education level" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```
```{r}
SETT$Modalita <- factor(SETT$Modalita,
                  levels = c(1, 2, 3, 4, 5),
                  labels = c("agricoltura",
                             "industria",
                             "servizi pubblici",
                             "altri settori",
                             "nessun"))
SETT
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
SETT %>% reframe("Sector" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Sector = c("agricoltura", "industria", "servizi pubblici", "altri settori", "nessun"),
  PFIMM = c(45.84005, 81.22453, 82.81169, 79.94146, 55.32840),
  PFCONS = c(1.235083, 4.564621, 4.434198, 3.187825, 9.980634),
  PFAZ = c(51.495771, 8.056295, 11.339217, 14.786204, 22.378737),
  PFCARTE = c(0.02013035, 0.17140601, 0.17892247, 0.10188922, 0.69119103),
  PFCC = c(0.7996218, 1.1374775, 0.8963161, 0.7735587, 1.6942111),
  PF3 = c(0.6093480, 4.8456685, 0.3396559, 1.2090601, 9.9268300)
)

library(tidyr)
df_long <- pivot_longer(df, cols = -Sector, names_to = "Debt_Category", values_to = "Percentage")


ggplot(df_long, aes(x = Sector, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Sector",
       x = "Sector",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### number of individuals indebted
```{r}
SETT %>% reframe("Sector" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```
```{r}
SETT %>% reframe("Sector" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```

```{r}
library(kableExtra)

df <- data.frame(
  Sector = c("agricoltura",
                             "industria",
                             "servizi pubblici",
                             "altri settori",
                             "nessun"),
  `Average duration (years)` = c(21.09825	, 25.02874, 24.74835, 25.16128, 21.59685),
  `Average number of suspensions` = c(0.0, 846799.7, 708804.1, 11673792.2, 775274.6),
  `Average duration (years)` = c(19.83550, 24.10698, 20.51910, 20.61805, 13.73175),
  `Average number of suspensions` = c(0.00	,57179.28	,135340.68	,876190.92	,40613.75),
  `Average duration (years)` = c(5.160719	,5.972203	,6.264451	,6.674705	,6.458724),
  `Average number of suspensions` = c(0.00	,60481.42	,17561.13	,326879.56	,58893.03),
  `Average duration (years)` = c(17.96165,16.96605,14.03896,13.73738,22.79008),
  `Average number of suspensions` = c(0, 0, 0, 0, 0)
)

kbl(df) %>%
  kable_classic() %>%
  add_header_above(c(" " = 1, 
                     "Indebtedness for primary residence" = 2, 
                     "Indebtedness for other properties" = 2, 
                     "Other debts for family needs" = 2, 
                     "Debts for professional activity" = 2))

```

```{r}
SETT %>% reframe("Sector" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
SETT %>% reframe("Sector" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```


```{r}
IREG$Modalita <- factor(IREG$Modalita,
                  levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20),
                  labels = c("Piemonte",
                             "Valle d'Aosta",
                             "Lombardia",
                             "Trentino",
                             "Veneto",
                             "Friuli",
                             "Liguria",
                             "Emilia Romagna",
                             "Toscana",
                             "Umbria",
                             "Marche",
                             "Lazio",
                             "Abruzzo",
                             "Molise",
                             "Campania",
                             "Puglia",
                             "Basilicata",
                             "Calabria",
                             "Sicilia",
                             "Sardegna"))
IREG
```

### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
IREG %>% reframe("Region" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
### number of individuals indebted
```{r}
IREG %>% reframe("Region" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```

```{r}
IREG %>% reframe("Region" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```


```{r}
IREG %>% reframe("Region" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
IREG %>% reframe("Region" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```

#ACOM5 = ampiezza demografica del comune
```{r}
ACOM5$Modalita <- factor(ACOM5$Modalita,
                  levels = c(1, 2, 3, 4, 5),
                  labels = c("fino a 5.000 abitanti",
                             "5.000-20.000",
                             "20.000-50.000",
                             "50.000-200.000",
                             "oltre 200.000"
))
ACOM5
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
ACOM5 %>% reframe("Demographic size of the municipality" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Municipality_Size = c("fino a 5.000 abitanti", "5.000-20.000", "20.000-50.000", "50.000-200.000", "oltre 200.000"),
  PFIMM = c(76.05008, 75.35718, 66.62738, 77.49791, 87.48584),
  PFCONS = c(15.188222, 4.079181, 3.231837, 4.338393, 2.320720),
  PFAZ = c(4.948312, 13.112973, 28.276383, 14.549183, 9.108661),
  PFCARTE = c(1.10730191, 0.12783607, 0.12544677, 0.15652268, 0.05776439),
  PFCC = c(2.3567059, 1.3487888, 0.7790674, 1.0246546, 0.4235607)
)


library(tidyr)
df_long <- pivot_longer(df, cols = -Municipality_Size, names_to = "Debt_Category", values_to = "Percentage")

# Plot stacked bar chart
ggplot(df_long, aes(x = Municipality_Size, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Municipality Size",
       x = "Municipality Size",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### number of individuals indebted
```{r}
ACOM5 %>% reframe("Demographic size of the municipality" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```
```{r}
ACOM5 %>% reframe("Demographic size of the municipality" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```


```{r}
ACOM5 %>% reframe("Demographic size of the municipality" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
ACOM5 %>% reframe("Demographic size of the municipality" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```

#QUAL = status del lavoratore
```{r}
QUAL$Modalita <- factor(QUAL$Modalita,
                  levels = c(1, 2, 3, 4, 5, 6, 7),
                  labels = c("operaio",
                             "impiegato",
                             "dirigente/direttivo",
                             "imprenditore/libero
professionista",
                             "altro autonomo",
"pensionato",
"altri non occupati"
))
QUAL
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
QUAL %>% reframe("Worker status" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Worker_Status = c("operaio", "impiegato", "dirigente/direttivo", "imprenditore/libero\nprofessionista", "altro autonomo", "pensionato", "altri non occupati"),
  PFIMM = c(82.92112, 94.02920, 94.62955, 61.87915, 55.10800, 52.09258, 79.81840),
  PFCONS = c(7.459770, 3.707295, 2.723480, 1.845715, 3.879250, 10.787161, 3.876506),
  PFAZ = c(6.887518, 0.648127, 0.137398, 33.382897, 38.855779, 24.596892, 5.590811),
  PFCARTE = c(0.14867413, 0.13740605, 0.05197579, 0.12185587, 0.13861708, 0.77877209, 0.02834097),
  PFCC = c(0.7343484, 0.6924752, 0.5023233, 0.9506809, 1.7171213, 1.5740843, 2.6033809)
)


library(tidyr)
df_long <- pivot_longer(df, cols = -Worker_Status, names_to = "Debt_Category", values_to = "Percentage")


ggplot(df_long, aes(x = Worker_Status, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Worker Status",
       x = "Worker Status",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### number of individuals indebted
```{r}
QUAL %>% reframe("Worker status" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```
```{r}
QUAL %>% reframe("Worker status" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```


```{r}
QUAL %>% reframe("Worker status" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
QUAL %>% reframe("Worker status" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```


#AREA5 = area geografica
```{r}
AREA5$Modalita <- factor(AREA5$Modalita,
                  levels = c(1, 2, 3, 4, 5),
                  labels = c("Nord Ovest",
                             "Nord Est",
                             "Centro",
                             "Sud",
                             "Isole"
))
AREA5
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
AREA5 %>% reframe("Regional area" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Regional_Area = c("Nord Ovest", "Nord Est", "Centro", "Sud", "Isole"),
  PFIMM = c(79.21144, 69.84424, 82.02840, 76.86216, 79.29816),
  PFCONS = c(2.905396, 2.619103, 5.438366, 5.580587, 8.272813),
  PFAZ = c(15.188267, 24.854179, 10.036455, 9.195358, 9.904306),
  PFCARTE = c(0.08000387, 0.07416655, 0.12091444, 0.67076838, 0.53002523),
  PFCC = c(0.6984800, 1.0069640, 0.6935992, 1.7368423, 1.3350067),
  PF3 = c(1.9164132, 1.6013512, 1.6822672, 5.9542885, 0.6596931)
)


library(tidyr)
df_long <- pivot_longer(df, cols = -Regional_Area, names_to = "Debt_Category", values_to = "Percentage")


ggplot(df_long, aes(x = Regional_Area, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Regional Area",
       x = "Regional Area",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


### number of individuals indebted
```{r}
AREA5 %>% reframe("Regional area" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```
```{r}
AREA5 %>% reframe("Regional area" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```


```{r}
AREA5 %>% reframe("Regional area" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
AREA5 %>% reframe("Regional area" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```

#CLETA5 = classe di età (1=fino a 34 anni, 2=35-44, 3=45-54, 4=55-64, 5=oltre 64)
```{r}
CLETA5$Modalita <- factor(CLETA5$Modalita,
                 levels = c(1, 2, 3, 4, 5),
                 labels = c("fino a 34 anni", "from 35 to 44", "from 45 to 54", "from 55 to 64", "oltre 64"))
CLETA5
```

#(ratio mean_debt/mean_mutuo[=importo iniziale del debito])
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
CLETA5 %>% reframe("Age classes" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Age_Class = c("fino a 34 anni", "from 35 to 44", "from 45 to 54", "from 55 to 64", "oltre 64"),
  PFIMM = c(80.76110, 87.59380, 77.94134, 69.00114, 37.93922),
  PFCONS = c(2.360478, 3.137253, 3.908473, 4.366676, 8.023833),
  PFAZ = c(15.277728, 7.174385, 16.174041, 21.479753, 44.066076),
  PFCARTE = c(0.08009929, 0.04635285, 0.17293647, 0.31280235, 0.30100385),
  PFCC = c(0.7480828, 0.3373195, 0.7789715, 1.9119563, 1.7716161),
  PF3 = c(0.7725156, 1.7108852, 1.0242368, 2.9276720, 7.8982556)
)


library(tidyr)
df_long <- pivot_longer(df, cols = -Age_Class, names_to = "Debt_Category", values_to = "Percentage")


ggplot(df_long, aes(x = Age_Class, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Age Class",
       x = "Age Class",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
### number of individuals indebted
```{r}
CLETA5 %>% reframe("Age classes" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```
```{r}
CLETA5 %>% reframe("Age classes" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```


```{r}
CLETA5 %>% reframe("Age classes" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
CLETA5 %>% reframe("Age classes" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```
#Q = status del lavoratore (1=dipendente, 2=autonomo, 3=condiz. non professionale)
```{r}
Q$Modalita <- factor(Q$Modalita,
                 levels = c(1, 2, 3),
                 labels = c("dipendente", "autonomo", "condiz. non professionale"))
Q
```
### PERCENTAGES by category of debt (in terms of total value of residual debt)
```{r}
Q %>% reframe("Worker status" = Modalita, "PFIMM" = (sum_PFIMM_pond/Deb_tot_pond)*100, "PFCONS" = (sum_PFCONS_pond/Deb_tot_pond)*100, "PFAZ" = (sum_PFAZ_pond/Deb_tot_pond)*100, "PFCARTE" = (sum_PFCARTE_pond/Deb_tot_pond)*100, "PFCC" = (sum_PFCC_pond/Deb_tot_pond)*100, "PF3" = (sum_PF3_pond/Deb_tot_pond)*100)
```
```{r}
df <- data.frame(
  Worker_Status = c("dipendente", "autonomo", "condiz. non professionale"),
  PFIMM = c(91.62193, 60.45905, 55.32840),
  PFCONS = c(4.259105, 2.272204, 9.980634),
  PFAZ = c(1.94221, 34.53071, 22.37874),
  PFCARTE = c(0.1114586, 0.1253712, 0.6911910),
  PFCC = c(0.638664, 1.111425, 1.694211),
  PF3 = c(1.426630, 1.501238, 9.926830)
)


library(tidyr)
df_long <- pivot_longer(df, cols = -Worker_Status, names_to = "Debt_Category", values_to = "Percentage")


ggplot(df_long, aes(x = Worker_Status, y = Percentage, fill = Debt_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of Debt Categories by Worker Status",
       x = "Worker Status",
       y = "Percentage") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### number of individuals indebted
```{r}
Q %>% reframe("Worker status" = Modalita, "Households indebted for real estate purchase" = (n_indeb_imm_pond/freq_pond), "Households indebted for the purchase of consumer goods" = (n_indeb_cons_pond/freq_pond), "Households indebted for professional reasons" = n_indeb_az_pond/freq_pond, "Households indebted to relatives/friends" = n_indeb_3_pond/freq_pond)
```

```{r}
Q %>% reframe("Worker status" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
Q %>% reframe("Worker status" = Modalita,
                  "Average duration (years) Indebtedness for primary residence" = Durata_Ori_pond_MUTUOIN1,
                "Average number of suspensions Indebtedness for primary residence" = sum_MUTUOIN1_SOSPENS1,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN1,
                  "Average duration (years) Indebtedness for other properties" = Durata_Ori_pond_MUTUOIN2,
                "Average number of suspensions Indebtedness for other properties" = sum_MUTUOIN2_SOSPENS2,
                "Loan-to-Value Indebtedness for primary residence" = LTV1_pond_MUTUOIN2,
                  "Average duration (years) Other debts for family needs" = Durata_Ori_pond_MUTUOIN3,
                "Average number of suspensions Other debts for family needs" = sum_MUTUOIN3_SOSPENS3,
                  "Average duration (years) Debts for professional activity" = Durata_Ori_pond_MUTUOIN4
                )
```


```{r}
Q %>% reframe("Worker status" = Modalita, "Debt over wealth household" = Deb_tot_pond/sum_W_indeb_pond, "Debt over income household" = Deb_tot_pond/sum_Y_FAM_indeb_pond)
```
```{r}
Q %>% reframe("Worker status" = Modalita, "Participation rate" = n_indeb_compl_pond/freq_pond, "Weighted Mean Tax residential building" = Tasso_pond1, "Weighted Mean Tax other real estate" = Tasso_pond2, "Weighted Mean Tax family needs" = TAEG_pond3, "Weighted Mean Tax professional activity" = Tasso_pond4)
```



